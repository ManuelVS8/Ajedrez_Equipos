<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Torneo de Ajedrez por Equipos FIDE</title>
    <meta name="theme-color" content="#e67e22">
    
    <link rel="icon" href="https://raw.githubusercontent.com/ManuelVS8/Ajedrez_Equipos/refs/heads/main/Torneo_ajedrez.ico" type="image/x-icon">
    
    <link rel="manifest" href="manifest.json">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #ecf0f1;
            --accent: #e67e22;
            --accent-light: #fcefe9;
            --success: #27ae60;
            --win-color: #27ae60;
            --loss-color: #c0392b;
            --draw-color: #3498db;
            --round-done: #d1ecf1;
            --round-done-text: #0c5460;
            --danger: #c0392b;
            --text: #333;
            --light-text: #7f8c8d;
            --border: #bdc3c7;
            --card-bg: #ffffff;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { margin: 0; padding: 0; background-color: var(--secondary); color: var(--text); padding-bottom: 80px; }

        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-text { text-align: left; flex: 1; }
        h1 { margin: 0; font-size: 1.2rem; }
        .subtitle { font-size: 0.8rem; opacity: 0.9; margin-top: 2px; font-weight: normal; }
        
        #adminBtn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; 
            border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.3s;
            margin-left: 10px; flex-shrink: 0;
        }
        #adminBtn:active { background-color: rgba(255,255,255,0.3); }
        #adminBtn.unlocked { background-color: var(--success); border-color: var(--success); }

        .container { padding: 1rem; max-width: 700px; margin: 0 auto; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity:1; } }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        body.is-locked .editable-element {
            opacity: 0.3;
            pointer-events: none;
            user-select: none;
        }
        
        .lock-overlay {
            display: none;
            text-align: center;
            color: var(--danger);
            padding: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.9);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        body.is-locked .show-lock-msg .lock-overlay {
            display: block;
        }

        body.is-locked .modal .editable-element,
        body.is-locked .modal-content input,
        body.is-locked .modal-content button {
            opacity: 1 !important;
            pointer-events: auto !important;
            user-select: auto !important;
        }

        button {
            background-color: var(--primary); color: white; border: none;
            padding: 12px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer;
            width: 100%; margin-top: 10px; font-weight: bold;
            transition: background 0.2s;
        }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: var(--light-text); }
        button.export { background-color: var(--success); }
        button.danger { background-color: var(--danger); }
        button.small { padding: 8px 15px; font-size: 0.9rem; width: auto; margin-top: 0; }
        button.toggle-active { background-color: var(--accent); color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .info-box {
            background-color: #e8f4f8;
            border-left: 4px solid var(--accent);
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #444;
        }
        .info-box strong { color: var(--primary); display: block; margin-bottom: 4px; }

        .team-setup-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        
        .team-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        
        .team-header input {
            font-weight: bold; font-size: 1.1rem; width: 70%; padding: 5px;
            border: 1px solid var(--border); border-radius: 4px;
        }

        .player-list {
            display: flex; flex-direction: column; gap: 8px;
        }

        .player-row {
            display: flex; gap: 5px; align-items: center;
        }

        .player-row input {
            flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px;
        }
        
        .player-num {
            color: var(--light-text); font-weight: bold; width: 20px; font-size: 0.9rem;
        }

        .team-match-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .team-match-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;
        }

        .team-score-display {
            font-size: 1.2rem; font-weight: bold; color: var(--primary);
            background: #eee; padding: 5px 15px; border-radius: 20px;
        }

        .team-names {
            text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;
        }
        .team-subtitle {
            text-align: center; font-size: 0.8rem; color: var(--light-text); text-transform: uppercase; letter-spacing: 1px;
        }

        .board-row {
            display: flex; flex-direction: column; background: #f9f9f9;
            border-radius: 6px; padding: 10px; margin-bottom: 8px; border: 1px solid #eee;
        }
        
        .board-players {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.95rem;
        }

        .board-p1 { font-weight: 600; color: var(--primary); }
        .board-p2 { font-weight: 600; color: var(--text); text-align: right; }
        
        /* ESTILOS DE PUNTUACI√ìN (COLORES SIN NEGRITAS EN NOMBRES) */
        .board-p1.win, .board-p2.win { color: var(--win-color); }
        .board-p1.loss, .board-p2.loss { color: var(--loss-color); }
        .board-p1.draw, .board-p2.draw { color: var(--draw-color); }

        .board-select {
            width: 100%; padding: 8px; border-radius: 5px; border: 1px solid var(--border);
            background: white; font-size: 0.9rem;
        }

        .toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 10px 5px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background-color: var(--primary); color: white; font-size: 0.8rem; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .sb-col { text-align: right; font-size: 0.8rem; color: var(--light-text); }
        .points-col { text-align: right; font-weight: bold; color: var(--accent); font-size: 1.1rem; }
        .rank-col { width: 30px; text-align: center; color: var(--light-text); font-weight: bold; }

        .modal {
            display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { width: 50%; margin-top: 0; }

        #loadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 300; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white; display: flex;
            justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 99;
        }
        .nav-item { text-align: center; color: var(--light-text); font-size: 0.75rem; cursor: pointer; flex: 1; user-select: none; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        
        .round-selector { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; }
        .round-chip { 
            background: #eee; color: #555; padding: 5px 15px; border-radius: 20px; white-space: nowrap; 
            font-size: 0.9rem; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .round-chip.has-results { background-color: var(--round-done); color: var(--round-done-text); border: 1px solid var(--round-done-text); }
        .round-chip.active { background: var(--accent) !important; color: white !important; border-color: var(--accent) !important; }

        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 16px; position: fixed;
            z-index: 1000; left: 50%; bottom: 90px; transform: translateX(-50%); font-size: 1rem;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 90px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 90px; opacity: 1;} to {bottom: 60px; opacity: 0;} }

    </style>
</head>
<body class="is-locked">

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">Conectando...</div>
</div>

<header>
    <div class="header-text">
        <h1>IV Torneo interescolar</h1>
        <div class="subtitle">La Palma del Condado 2026</div>
    </div>
    <button id="adminBtn" onclick="openPasswordModal()" title="Admin">üîí</button>
</header>

<div class="container">
    
    <div id="tab-setup" class="tab-content active">
        <div class="card show-lock-msg">
            <h3>1. Configuraci√≥n de Equipos</h3>
            <p class="small">Crea los equipos y a√±ade sus jugadores.</p>
            <div class="lock-overlay">üîí Modo lectura: Pulsa el candado para editar</div>
            
            <div id="teamsSetupContainer"></div>

            <button class="editable-element" style="background-color: var(--accent); margin-top: 15px;" onclick="addNewTeamUI()">+ A√±adir Nuevo Equipo</button>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <button class="editable-element" onclick="confirmStartTournament()">Crear / Actualizar Torneo</button>
        </div>
        
        <div class="card show-lock-msg" id="resetCard" style="display:none;">
            <h3>Zona de Peligro</h3>
            <p style="color:var(--danger); font-size:0.9rem;">Esto borrar√° todos los resultados y equipos.</p>
            <div class="lock-overlay">üîí Zona protegida</div>
            <button class="editable-element danger" onclick="confirmResetTournament()">Borrar Todo</button>
        </div>
    </div>

    <div id="tab-rounds" class="tab-content">
        <div class="round-selector" id="roundSelector"></div>
        <div id="matchesContainer"></div>
        <div style="height: 20px;"></div> 
        <div class="card show-lock-msg" style="padding: 0; background: transparent; box-shadow: none;">
             <div class="lock-overlay">üîí Necesitas desbloquear para guardar</div>
             <button id="saveBtn" class="editable-element" onclick="syncToGoogle()">Guardar resultados</button>
        </div>
    </div>

    <div id="tab-ranking" class="tab-content">
        <div class="card">
            <h3>Clasificaci√≥n</h3>
            
            <div class="toggle-container">
                <button id="btnRankTeams" class="small secondary toggle-active" onclick="toggleRankingView('teams')">Equipos</button>
                <button id="btnRankPlayers" class="small secondary" onclick="toggleRankingView('players')">Jugadores</button>
            </div>

            <div id="tieBreakInfo" class="info-box">
                </div>

            <table id="rankingTable">
                <thead>
                    <tr id="rankingHeaderRow">
                        </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="tab-export" class="tab-content">
        <div class="card">
            <h3>Exportar a PDF</h3>
            <p>Descarga el informe completo con los resultados por equipos y tableros.</p>
            <button class="export" onclick="downloadPDF()">‚¨áÔ∏è Descargar PDF</button>
        </div>
    </div>

</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('tab-setup', this)">
        <span class="nav-icon">‚öôÔ∏è</span>Inicio
    </div>
    <div class="nav-item" onclick="switchTab('tab-rounds', this)">
        <span class="nav-icon">üìÖ</span>Rondas
    </div>
    <div class="nav-item" onclick="switchTab('tab-ranking', this)">
        <span class="nav-icon">üèÜ</span>Ranking
    </div>
    <div class="nav-item" onclick="switchTab('tab-export', this)">
        <span class="nav-icon">üìÑ</span>Exportar
    </div>
</div>

<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle">¬øEst√°s seguro?</h3>
        <p id="confirmMessage">Mensaje de confirmaci√≥n.</p>
        <div class="modal-buttons">
            <button class="secondary" onclick="closeConfirmModal(false)">Cancelar</button>
            <button id="confirmActionBtn" onclick="closeConfirmModal(true)">Confirmar</button>
        </div>
    </div>
</div>

<div id="pwdModal" class="modal">
    <div class="modal-content">
        <h3>Acceso Admin</h3>
        <p>Introduce la contrase√±a:</p>
        <input type="password" id="pwdInput" placeholder="Contrase√±a" onkeydown="if(event.key === 'Enter') checkPassword()">
        <button onclick="checkPassword()">Entrar</button>
        <button class="secondary" onclick="closePasswordModal()" style="margin-top:5px;">Cancelar</button>
    </div>
</div>

<div id="toast">Notificaci√≥n</div>

<audio id="tapSound" src="https://raw.githubusercontent.com/ManuelVS8/Efectos_audio/refs/heads/main/Tap.mp3" preload="auto"></audio>

<script>
    // --- CONFIGURACI√ìN DEFINITIVA ---
    const ADMIN_PASS = "ajedrez2026";
    // URL GOLDILOCKS FINAL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjeWw4PBusWTnT6ekqNgUNyAc8zEY1UjGnnFS-6j-3BRs5BtbdBIIVs8J0Lgl5SACk/exec";

    let isAdmin = false;
    let appData = { teams: [], matches: [], started: false };
    let currentRound = 1;
    let pendingAction = null;
    let rankingViewMode = 'teams';

    // --- PWA ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registrado', reg))
                .catch(err => console.log('SW fall√≥', err));
        });
    }

    // --- INIT (Motor de arranque robusto) ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Intentamos cargar de Google primero
        await fetchFromGoogle();
        
        // Si tras cargar de Google no hay datos (o fall√≥), intentamos recuperar de LocalStorage
        if (!appData.teams || appData.teams.length === 0) {
            console.log("Datos no encontrados en Google. Buscando Local...");
            loadFromLocal();
        }

        renderUI();
        updateAdminMode();
    });

    // --- SINCRONIZACI√ìN LOCAL ---
    function saveLocal() {
        try {
            localStorage.setItem('ajedrezAppData', JSON.stringify(appData));
        } catch (e) {
            console.error("Error guardando local:", e);
        }
    }

    function loadFromLocal() {
        try {
            const local = localStorage.getItem('ajedrezAppData');
            if (local) {
                const parsed = JSON.parse(local);
                if (parsed.teams && parsed.teams.length > 0) {
                    appData = parsed;
                }
            }
        } catch (e) {
            console.error("Error leyendo local:", e);
        }
    }

    // --- GOOGLE SHEETS INTEGRACI√ìN ---

    async function fetchFromGoogle() {
        const msg = (appData.teams.length === 0) ? "Iniciando sistema..." : "Sincronizando datos...";
        showLoading(msg);

        try {
            const response = await fetch(`${SCRIPT_URL}?action=read&t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

            const text = await response.text();
            const data = JSON.parse(text);
            
            if (data && data.db) {
                appData = data.db;
                saveLocal();
            }
        } catch (error) {
            console.error("Error cargando datos:", error);
            if (appData.teams && appData.teams.length > 0) {
                showToast("Error de conexi√≥n. Usando datos locales.");
            }
        } finally {
            hideLoading();
            renderUI(); // Asegurar visibilidad inmediata tras carga
        }
    }

    async function syncToGoogle() {
        if (!isAdmin) {
            showToast("Modo Solo Lectura");
            return;
        }
        
        showLoading("Guardando resultados en la nube...");
        playTap(); 

        const payload = {
            action: 'sync',
            db: appData 
        };
        
        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'application/json' }
            });
            
            saveLocal(); 
            showToast(`‚úÖ Datos guardados.`);
            setTimeout(fetchFromGoogle, 4000);
            return; 
        } catch (e) {
            console.error("Error de red:", e);
            showToast("‚ùå Error de red.");
            saveLocal();
            hideLoading();
        }
    }

    async function sendGoogleAction(action, extraData = {}) {
        showLoading("Procesando...");
        playTap();
        try {
            let payload = { action: action, db: appData, ...extraData };
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            saveLocal();
            return true;
        } catch (error) {
            showToast("Error de conexi√≥n");
            return false;
        } finally {
            hideLoading();
        }
    }

    function showLoading(msg) {
        const loader = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        if (text) text.textContent = msg || "Cargando...";
        if (loader) loader.style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = "none";
    }

    function playTap() {
        const audio = document.getElementById('tapSound');
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play blocked"));
        }
    }

    // --- SECURITY / ADMIN ---
    function openPasswordModal() {
        playTap();
        if (isAdmin) {
            isAdmin = false;
            updateAdminMode();
            showToast("Modo Admin desactivado");
        } else {
            const modal = document.getElementById('pwdModal');
            modal.style.display = "flex";
            setTimeout(() => document.getElementById('pwdInput').focus(), 100);
        }
    }

    function closePasswordModal() {
        playTap();
        document.getElementById('pwdModal').style.display = "none";
    }

    function checkPassword() {
        playTap();
        const input = document.getElementById('pwdInput').value;
        if (input === ADMIN_PASS) {
            isAdmin = true;
            closePasswordModal();
            updateAdminMode();
            showToast("Modo Editor activado");
        } else {
            showToast("Contrase√±a incorrecta");
            document.getElementById('pwdInput').value = "";
        }
    }

    function updateAdminMode() {
        const btn = document.getElementById('adminBtn');
        if (isAdmin) {
            btn.innerHTML = "üîì";
            btn.classList.add('unlocked');
            document.body.classList.remove('is-locked');
        } else {
            btn.innerHTML = "üîí";
            btn.classList.remove('unlocked');
            document.body.classList.add('is-locked');
        }
    }

    // --- MODALS (INTEGRADOS - NO NAVEGADOR) ---
    function openConfirmModal(title, message, actionType) {
        playTap();
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmMessage').innerText = message;
        const btn = document.getElementById('confirmActionBtn');
        btn.className = ""; 
        if (actionType === 'danger') btn.classList.add('danger');
        else btn.style.backgroundColor = "var(--primary)";
        document.getElementById('confirmModal').style.display = "flex";
        pendingAction = actionType;
    }

    function closeConfirmModal(confirmed) {
        playTap();
        document.getElementById('confirmModal').style.display = "none";
        if (confirmed && pendingAction) {
            if (pendingAction === 'start') startTournamentLogic();
            else if (pendingAction === 'reset') resetTournamentLogic();
            else if (pendingAction === 'deleteTeam') executeRemoveTeam();
        }
        pendingAction = null;
    }

    // --- SETUP LOGIC ---
    function renderTeamsSetup() {
        const container = document.getElementById('teamsSetupContainer');
        container.innerHTML = "";
        if (appData.teams && appData.teams.length > 0) {
            appData.teams.forEach((team, index) => {
                const teamCard = document.createElement('div');
                teamCard.className = 'team-setup-card';
                let playersHTML = '';
                team.players.forEach((p, pIndex) => {
                    playersHTML += `
                        <div class="player-row">
                            <span class="player-num">${pIndex +1}.</span>
                            <input type="text" class="editable-element" value="${p.name}" placeholder="Nombre Jugador" onchange="updatePlayerName(${index}, ${pIndex}, this.value)">
                            ${isAdmin ? `<button class="danger small" onclick="removePlayer(${index}, ${pIndex})">√ó</button>` : ''}
                        </div>
                    `;
                });
                teamCard.innerHTML = `
                    <div class="team-header">
                        <input type="text" class="editable-element" value="${team.name}" placeholder="Nombre del Equipo" onchange="updateTeamName(${index}, this.value)">
                        ${isAdmin && appData.teams.length >1 ? `<button class="danger small" onclick="removeTeam(${index})">Eliminar</button>` : ''}
                    </div>
                    <div class="player-list">${playersHTML}<div style="margin-top: 10px; text-align: center;"><button class="secondary editable-element small" style="width:100%; font-size: 0.8rem;" onclick="addPlayerToTeam(${index})">+ A√±adir Jugador</button></div></div>
                `;
                container.appendChild(teamCard);
            });
        }
    }

    function addNewTeamUI() {
        if(!isAdmin) return;
        playTap();
        const newId = Date.now().toString();
        appData.teams.push({ id: newId, name: `Equipo ${appData.teams.length +1}`, players: [ { id: newId + "_p1", name: "" }, { id: newId + "_p2", name: "" } ] });
        saveLocal(); 
        renderTeamsSetup();
    }

    let teamToDelete = null;
    function removeTeam(teamIndex) {
        if(!isAdmin) return;
        teamToDelete = teamIndex;
        openConfirmModal("Eliminar Equipo", "¬øSeguro que quieres borrar este equipo y sus jugadores?", 'deleteTeam');
    }

    function executeRemoveTeam() {
        if (teamToDelete !== null) {
            appData.teams.splice(teamToDelete, 1);
            saveLocal();
            renderTeamsSetup();
            teamToDelete = null;
            showToast("Equipo eliminado");
        }
    }

    function updateTeamName(index, val) { appData.teams[index].name = val; saveLocal(); }
    function addPlayerToTeam(teamIndex) {
        if(!isAdmin) return;
        playTap();
        const teamId = appData.teams[teamIndex].id;
        appData.teams[teamIndex].players.push({ id: teamId + "_p" + (Date.now()), name: "" });
        saveLocal();
        renderTeamsSetup();
    }
    function removePlayer(teamIndex, playerIndex) {
        if(!isAdmin) return;
        appData.teams[teamIndex].players.splice(playerIndex, 1);
        saveLocal();
        renderTeamsSetup();
    }
    function updatePlayerName(teamIndex, playerIndex, val) {
        appData.teams[teamIndex].players[playerIndex].name = val;
        saveLocal();
    }

    // --- TOURNAMENT LOGIC ---
    function confirmStartTournament() {
        if (!isAdmin) return showToast("Necesitas ser Admin");
        const validTeams = appData.teams.filter(t => t.players.length > 0);
        if (validTeams.length < 2) return showToast("M√≠nimo 2 equipos");
        
        let title = "Crear Torneo";
        let msg = "¬øGenerar emparejamientos?";
        if (appData.started) {
            title = "Actualizar Torneo";
            msg = "Esto borrar√° los resultados actuales.";
        }
        openConfirmModal(title, msg, 'start');
    }

    function startTournamentLogic() {
        playTap();
        let shuffledTeams = [...appData.teams].sort(() => Math.random() - 0.5);
        if (shuffledTeams.length % 2 !== 0) {
            shuffledTeams.push({ id: "bye", name: "DESCANSA", players: [] });
        }
        
        const n = shuffledTeams.length;
        const totalRounds = n - 1;
        const matches = [];
        let pivot = shuffledTeams[0];
        let rotating = shuffledTeams.slice(1);

        for (let r = 1; r <= totalRounds; r++) {
            let roundTeams = [pivot, ...rotating];
            for (let i = 0; i < n / 2; i++) {
                let t1 = roundTeams[i];
                let t2 = roundTeams[n - 1 - i];
                if (t1.id !== "bye" && t2.id !== "bye") {
                    let isT1Local = (r % 2 !== 0) ? (i % 2 === 0) : (i % 2 !== 0);
                    let local = isT1Local ? t1 : t2;
                    let visit = isT1Local ? t2 : t1;
                    const teamMatchId = `R${r}_M${i}`;
                    const numBoards = Math.max(local.players.length, visit.players.length);
                    for (let b = 1; b <= numBoards; b++) {
                        matches.push({
                            id: `${teamMatchId}_B${b}`, round: r, teamMatchId: teamMatchId,
                            team1Id: local.id, team2Id: visit.id,
                            player1Id: local.players[b-1] ? local.players[b-1].id : "vacante",
                            player2Id: visit.players[b-1] ? visit.players[b-1].id : "vacante",
                            boardNum: b, localIsWhite: (b % 2 !== 0), result: ""
                        });
                    }
                }
            }
            rotating.unshift(rotating.pop());
        }
        appData.matches = matches;
        appData.started = true;
        saveLocal(); 
        showLoading("Sincronizando...");
        sendGoogleAction('sync').then(() => {
            setTimeout(() => {
                hideLoading(); renderUI();
                switchTab('tab-rounds', document.querySelectorAll('.nav-item')[1]);
                showToast("Torneo generado");
            }, 4000); 
        });
    }

    function confirmResetTournament() {
        if (!isAdmin) return;
        openConfirmModal("Borrar Todo", "¬øSeguro que quieres resetear todo?", 'reset');
    }

    function resetTournamentLogic() {
        playTap();
        appData = { teams: [], matches: [], started: false };
        saveLocal(); 
        showLoading();
        sendGoogleAction('reset').then(() => {
            hideLoading(); renderUI(); showToast("Torneo borrado");
        });
    }

    function updateMatch(matchId, result) {
        if (!isAdmin) return; 
        playTap();
        const match = appData.matches.find(m => m.id === matchId);
        if (match) {
            match.result = result;
            saveLocal();
        }
        renderMatches(currentRound); renderRoundSelector();
    }

    // --- RENDERING ---
    function renderUI() {
        // Equipos siempre visibles en setup
        renderTeamsSetup();

        if (appData.started) {
            document.getElementById('resetCard').style.display = "block";
            renderRoundSelector();
            renderMatches(currentRound);
            renderRanking();
        } else {
            document.getElementById('resetCard').style.display = "none";
            document.getElementById('roundSelector').innerHTML = "";
            document.getElementById('matchesContainer').innerHTML = "<p style='text-align:center'>Configura los equipos para empezar.</p>";
        }
    }

    function renderRoundSelector() {
        const totalRounds = appData.matches.length > 0 ? Math.max(...appData.matches.map(m => m.round)) : 0;
        const container = document.getElementById('roundSelector');
        container.innerHTML = "";
        for (let i = 1; i <= totalRounds; i++) {
            const chip = document.createElement('div');
            let classes = ["round-chip"];
            const roundMatches = appData.matches.filter(m => m.round === i);
            if (roundMatches.some(m => m.result !== "")) classes.push("has-results");
            if (i === currentRound) classes.push("active");
            chip.className = classes.join(" ");
            chip.innerText = `Ronda ${i}`;
            chip.onclick = () => { playTap(); currentRound = i; renderRoundSelector(); renderMatches(i); };
            container.appendChild(chip);
        }
    }

    function renderMatches(roundNum) {
        const container = document.getElementById('matchesContainer');
        if (!container) return;
        container.innerHTML = "";
        const roundMatches = appData.matches.filter(m => m.round === roundNum);
        if (roundMatches.length === 0) return;

        const teamGroups = {};
        roundMatches.forEach(m => { if (!teamGroups[m.teamMatchId]) teamGroups[m.teamMatchId] = []; teamGroups[m.teamMatchId].push(m); });

        Object.keys(teamGroups).forEach(gId => {
            const g = teamGroups[gId];
            const t1 = appData.teams.find(t => t.id === g[0].team1Id);
            const t2 = appData.teams.find(t => t.id === g[0].team2Id);
            if (!t1 || !t2) return; 

            let score1 = 0, score2 = 0;
            g.forEach(m => {
                if (m.result === '1-0') score1++;
                else if (m.result === '0-1') score2++;
                else if (m.result === '1/2-1/2') { score1 += 0.5; score2 += 0.5; }
            });

            const card = document.createElement('div');
            card.className = 'team-match-card';
            card.innerHTML = `
                <div class="team-match-header">
                    <div style="text-align:center; flex:1;"><div class="team-names">${t1.name}</div><div class="team-subtitle">Local</div></div>
                    <div class="team-score-display">${score1} - ${score2}</div>
                    <div style="text-align:center; flex:1;"><div class="team-names">${t2.name}</div><div class="team-subtitle">Visitante</div></div>
                </div>
            `;

            g.forEach(m => {
                const p1 = t1.players.find(p => p.id === m.player1Id);
                const p2 = t2.players.find(p => p.id === m.player2Id);
                if (m.player1Id === "vacante" || m.player2Id === "vacante") return;

                let p1Class = "board-p1", p2Class = "board-p2";
                if (m.result === '1-0') { p1Class += " win"; p2Class += " loss"; } 
                else if (m.result === '0-1') { p2Class += " win"; p1Class += " loss"; } 
                else if (m.result === '1/2-1/2') { p1Class += " draw"; p2Class += " draw"; }

                const boardDiv = document.createElement('div');
                boardDiv.className = 'board-row';
                boardDiv.innerHTML = `
                    <div class="board-players">
                        <div class="${p1Class}">${m.localIsWhite ? "‚ôî" : "‚ôö"} ${p1 ? p1.name : 'N/A'}</div>
                        <div class="${p2Class}">${p2 ? p2.name : 'N/A'} ${m.localIsWhite ? "‚ôö" : "‚ôî"}</div>
                    </div>
                    <select class="board-select editable-element" onchange="updateMatch('${m.id}', this.value)">
                        <option value="" ${m.result === "" ? "selected" : ""}>Resultado...</option>
                        <option value="1-0" ${m.result === "1-0" ? "selected" : ""}>1-0</option>
                        <option value="0-1" ${m.result === "0-1" ? "selected" : ""}>0-1</option>
                        <option value="1/2-1/2" ${m.result === "1/2-1/2" ? "selected" : ""}>¬Ω-¬Ω</option>
                    </select>
                `;
                card.appendChild(boardDiv);
            });
            container.appendChild(card);
        });
    }

    function toggleRankingView(mode) {
        playTap(); rankingViewMode = mode;
        document.getElementById('btnRankTeams').className = mode === 'teams' ? 'small secondary toggle-active' : 'small secondary';
        document.getElementById('btnRankPlayers').className = mode === 'players' ? 'small secondary toggle-active' : 'small secondary';
        renderRanking();
    }

    function renderRanking() {
        const thead = document.querySelector('#rankingTable thead');
        const tbody = document.querySelector('#rankingTable tbody');
        tbody.innerHTML = ""; thead.innerHTML = "";
        const headerRow = document.createElement('tr');
        
        if (rankingViewMode === 'teams') {
            document.getElementById('tieBreakInfo').innerHTML = "<strong>Desempate:</strong> MP > GP > SB";
            headerRow.innerHTML = `<th>#</th><th>Equipo</th><th class="points-col">MP</th><th class="points-col">GP</th>`;
            thead.appendChild(headerRow);
            const stats = calculateTeamStats(); 
            stats.forEach((t, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i + 1}</td><td>${t.name}</td><td class="points-col">${t.mp}</td><td class="points-col">${t.gp}</td>`;
                tbody.appendChild(tr);
            });
        } else {
            document.getElementById('tieBreakInfo').innerHTML = "<strong>Desempate:</strong> Puntos > SB > Directo";
            headerRow.innerHTML = `<th>#</th><th>Jugador</th><th class="points-col">Pts</th>`;
            thead.appendChild(headerRow);
            // L√≥gica simplificada de ranking individual
            let pStats = [];
            appData.teams.forEach(t => t.players.forEach(p => pStats.push({id:p.id, name:p.name, team:t.name, pts:0})));
            appData.matches.forEach(m => {
                let p1 = pStats.find(x => x.id === m.player1Id);
                let p2 = pStats.find(x => x.id === m.player2Id);
                if (p1 && p2) {
                    if (m.result === '1-0') p1.pts++; else if (m.result === '0-1') p2.pts++; else if (m.result === '1/2-1/2') { p1.pts+=0.5; p2.pts+=0.5; }
                }
            });
            pStats.sort((a,b) => b.pts - a.pts).forEach((p, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${i+1}</td><td>${p.name}<br><small>${p.team}</small></td><td class="points-col">${p.pts}</td>`;
                tbody.appendChild(tr);
            });
        }
    }

    function calculateTeamStats() {
        let stats = appData.teams.map(t => ({ id: t.id, name: t.name, mp: 0, gp: 0 }));
        const groups = {};
        appData.matches.forEach(m => {
            if (!m.result || m.player1Id === "vacante") return;
            let t1 = stats.find(s => s.id === m.team1Id);
            let t2 = stats.find(s => s.id === m.team2Id);
            if (m.result === '1-0') t1.gp++; else if (m.result === '0-1') t2.gp++; else { t1.gp+=0.5; t2.gp+=0.5; }
            if (!groups[m.teamMatchId]) groups[m.teamMatchId] = { s1: 0, s2: 0, id1: m.team1Id, id2: m.team2Id };
            if (m.result === '1-0') groups[m.teamMatchId].s1++; else if (m.result === '0-1') groups[m.teamMatchId].s2++; else { groups[m.teamMatchId].s1+=0.5; groups[m.teamMatchId].s2+=0.5; }
        });
        Object.values(groups).forEach(g => {
            let t1 = stats.find(s => s.id === g.id1); let t2 = stats.find(s => s.id === g.id2);
            if (g.s1 > g.s2) t1.mp+=2; else if (g.s2 > g.s1) t2.mp+=2; else { t1.mp++; t2.mp++; }
        });
        return stats.sort((a, b) => b.mp - a.mp || b.gp - a.gp);
    }

    function switchTab(tabId, navItem) {
        playTap();
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navItem.classList.add('active');
        if (tabId === 'tab-ranking') renderRanking();
    }

    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message; x.className = "show";
        setTimeout(() => x.className = "", 3000);
    }

    function downloadPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.text("Acta de Resultados - Torneo Siurot", 20, 20);
        let y = 30;
        calculateTeamStats().forEach((t, i) => { doc.text(`${i+1}. ${t.name} - MP: ${t.mp} GP: ${t.gp}`, 20, y); y+=10; });
        doc.save("resultados.pdf");
    }

</script>
</body>
</html>
