<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Torneo de Ajedrez por Equipos FIDE</title>
    <meta name="theme-color" content="#e67e22">
    
    <!-- Favicon -->
    <link rel="icon" href="https://raw.githubusercontent.com/ManuelVS8/Ajedrez_Equipos/refs/heads/main/Torneo_ajedrez.ico" type="image/x-icon">
    
    <!-- MANIFESTO PARA PWA -->
    <link rel="manifest" href="manifest.json">

    <!-- Librer√≠a jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #ecf0f1;
            --accent: #e67e22;
            --accent-light: #fcefe9;
            --success: #27ae60;
            --win-color: #27ae60;
            --loss-color: #c0392b;
            --draw-color: #3498db;
            --round-done: #d1ecf1;
            --round-done-text: #0c5460;
            --danger: #c0392b;
            --text: #333;
            --light-text: #7f8c8d;
            --border: #bdc3c7;
            --card-bg: #ffffff;
        }

        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { margin: 0; padding: 0; background-color: var(--secondary); color: var(--text); padding-bottom: 80px; }

        header {
            background-color: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-text { text-align: left; flex: 1; }
        h1 { margin: 0; font-size: 1.2rem; }
        .subtitle { font-size: 0.8rem; opacity: 0.9; margin-top: 2px; font-weight: normal; }
        
        #adminBtn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; 
            border-radius: 50%; width: 40px; height: 40px; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.3s;
            margin-left: 10px; flex-shrink: 0;
        }
        #adminBtn:active { background-color: rgba(255,255,255,0.3); }
        #adminBtn.unlocked { background-color: var(--success); border-color: var(--success); }

        .container { padding: 1rem; max-width: 700px; margin: 0 auto; }

        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity:1; } }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }

        body.is-locked .editable-element {
            opacity: 0.3;
            pointer-events: none;
            user-select: none;
        }
        
        .lock-overlay {
            display: none;
            text-align: center;
            color: var(--danger);
            padding: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.9);
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        body.is-locked .show-lock-msg .lock-overlay {
            display: block;
        }

        body.is-locked .modal .editable-element,
        body.is-locked .modal-content input,
        body.is-locked .modal-content button {
            opacity: 1 !important;
            pointer-events: auto !important;
            user-select: auto !important;
        }

        button {
            background-color: var(--primary); color: white; border: none;
            padding: 12px 20px; border-radius: 5px; font-size: 1rem; cursor: pointer;
            width: 100%; margin-top: 10px; font-weight: bold;
            transition: background 0.2s;
        }
        button:active { transform: scale(0.98); }
        button.secondary { background-color: var(--light-text); }
        button.export { background-color: var(--success); }
        button.danger { background-color: var(--danger); }
        button.small { padding: 8px 15px; font-size: 0.9rem; width: auto; margin-top: 0; }
        button.toggle-active { background-color: var(--accent); color: white; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .info-box {
            background-color: #e8f4f8;
            border-left: 4px solid var(--accent);
            padding: 10px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #444;
        }
        .info-box strong { color: var(--primary); display: block; margin-bottom: 4px; }

        .team-setup-card {
            border:1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }
        
        .team-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        
        .team-header input {
            font-weight: bold; font-size: 1.1rem; width: 70%; padding: 5px;
            border:1px solid var(--border); border-radius: 4px;
        }

        .player-list {
            display: flex; flex-direction: column; gap: 8px;
        }

        .player-row {
            display: flex; gap: 5px; align-items: center;
        }

        .player-row input {
            flex: 1; padding: 8px; border: 1px solid var(--border); border-radius: 4px;
        }
        
        .player-num {
            color: var(--light-text); font-weight: bold; width: 20px; font-size: 0.9rem;
        }

        .team-match-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid var(--accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .team-match-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee;
        }

        .team-score-display {
            font-size: 1.2rem; font-weight: bold; color: var(--primary);
            background: #eee; padding: 5px 15px; border-radius: 20px;
        }

        .team-names {
            text-align: center; font-weight: bold; font-size: 1.1rem; margin-bottom: 5px;
        }
        .team-subtitle {
            text-align: center; font-size: 0.8rem; color: var(--light-text); text-transform: uppercase; letter-spacing: 1px;
        }

        .board-row {
            display: flex; flex-direction: column; background: #f9f9f9;
            border-radius: 6px; padding: 10px; margin-bottom: 8px; border: 1px solid #eee;
        }
        
        .board-players {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 0.95rem;
        }

        .board-p1 { font-weight: 600; color: var(--primary); }
        .board-p2 { font-weight: 600; color: var(--text); text-align: right; }
        
        /* ESTILOS CORREGIDOS POR GEMINI */
        .board-p1.win, .board-p2.win { color: var(--win-color); font-weight: 800; }
        .board-p1.loss, .board-p2.loss { color: var(--loss-color); font-weight: 800; }
        .board-p1.draw, .board-p2.draw { color: var(--draw-color); font-weight: 800; }

        .board-select {
            width: 100%; padding: 8px; border-radius:5px; border: 1px solid var(--border);
            background: white; font-size: 0.9rem;
        }

        .toggle-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; }
        th, td { padding: 10px 5px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        th { background-color: var(--primary); color: white; font-size: 0.8rem; }
        tr:nth-child(even) { background-color: #f8f9fa; }
        .sb-col { text-align: right; font-size: 0.8rem; color: var(--light-text); }
        .points-col { text-align: right; font-weight: bold; color: var(--accent); font-size: 1.1rem; }
        .rank-col { width: 30px; text-align: center; color: var(--light-text); font-weight: bold; }

        .modal {
            display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-buttons { display: flex; gap: 10px; }
        .modal-buttons button { width: 50%; margin-top: 0; }

        #loadingOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 300; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border:5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white; display: flex;
            justify-content: space-around; padding: 10px 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); z-index: 99;
        }
        .nav-item { text-align: center; color: var(--light-text); font-size: 0.75rem; cursor: pointer; flex: 1; user-select: none; }
        .nav-item.active { color: var(--accent); font-weight: bold; }
        .nav-icon { font-size: 1.2rem; display: block; margin-bottom: 2px; }
        
        .round-selector { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; }
        .round-chip { 
            background: #eee; color: #555; padding: 5px 15px; border-radius: 20px; white-space: nowrap; 
            font-size: 0.9rem; cursor: pointer; transition: all 0.2s; border: 1px solid transparent;
        }
        .round-chip.has-results { background-color: var(--round-done); color: var(--round-done-text); border: 1px solid var(--round-done-text); }
        .round-chip.active { background: var(--accent) !important; color: white !important; border-color: var(--accent) !important; }

        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff;
            text-align: center; border-radius: 4px; padding: 16px; position: fixed;
            z-index: 1000; left: 50%; bottom: 90px; transform: translateX(-50%); font-size: 1rem;
        }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 60px; opacity: 0;} to {bottom: 90px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 90px; opacity: 1;} to {bottom: 60px; opacity: 0;} }

    </style>
</head>
<body class="is-locked">

<div id="loadingOverlay">
    <div class="spinner"></div>
    <div id="loadingText">Conectando...</div>
</div>

<header>
    <div class="header-text">
        <h1>IV Torneo interescolar</h1>
        <div class="subtitle">La Palma del Condado 2026</div>
    </div>
    <button id="adminBtn" onclick="openPasswordModal()" title="Admin">üîí</button>
</header>

<div class="container">
    
    <!-- TAB 1: CONFIGURACI√ìN DE EQUIPOS -->
    <div id="tab-setup" class="tab-content active">
        <div class="card show-lock-msg">
            <h3>1. Configuraci√≥n de Equipos</h3>
            <p class="small">Crea los equipos y a√±ade sus jugadores.</p>
            <div class="lock-overlay">üîí Modo lectura: Pulsa el candado para editar</div>
            
            <div id="teamsSetupContainer"></div>

            <button class="editable-element" style="background-color: var(--accent); margin-top: 15px;" onclick="addNewTeamUI()">+ A√±adir Nuevo Equipo</button>
            
            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <button class="editable-element" onclick="confirmStartTournament()">Crear / Actualizar Torneo</button>
        </div>
        
        <div class="card show-lock-msg" id="resetCard" style="display:none;">
            <h3>Zona de Peligro</h3>
            <p style="color:var(--danger); font-size:0.9rem;">Esto borrar√° todos los resultados y equipos.</p>
            <div class="lock-overlay">üîí Zona protegida</div>
            <button class="editable-element danger" onclick="confirmResetTournament()">Borrar Todo</button>
        </div>
    </div>

    <!-- TAB 2: RONDAS -->
    <div id="tab-rounds" class="tab-content">
        <div class="round-selector" id="roundSelector"></div>
        <div id="matchesContainer"></div>
        <div style="height: 20px;"></div> 
        <div class="card show-lock-msg" style="padding: 0; background: transparent; box-shadow: none;">
             <div class="lock-overlay">üîí Necesitas desbloquear para guardar</div>
             <button id="saveBtn" class="editable-element" onclick="syncToGoogle()">Guardar resultados</button>
        </div>
    </div>

    <!-- TAB 3: CLASIFICACI√ìN -->
    <div id="tab-ranking" class="tab-content">
        <div class="card">
            <h3>Clasificaci√≥n</h3>
            
            <div class="toggle-container">
                <button id="btnRankTeams" class="small secondary toggle-active" onclick="toggleRankingView('teams')">Equipos</button>
                <button id="btnRankPlayers" class="small secondary" onclick="toggleRankingView('players')">Jugadores</button>
            </div>

            <div id="tieBreakInfo" class="info-box">
                <!-- Se llena din√°micamente -->
            </div>

            <table id="rankingTable">
                <thead>
                    <tr id="rankingHeaderRow">
                        <!-- Se llena din√°micamente -->
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- TAB 4: EXPORTAR -->
    <div id="tab-export" class="tab-content">
        <div class="card">
            <h3>Exportar a PDF</h3>
            <p>Descarga el informe completo con los resultados por equipos y tableros.</p>
            <button class="export" onclick="downloadPDF()">‚¨áÔ∏è Descargar PDF</button>
        </div>
    </div>

</div>

<!-- BOTTOM NAVIGATION -->
<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('tab-setup', this)">
        <span class="nav-icon">‚öôÔ∏è</span>Inicio
    </div>
    <div class="nav-item" onclick="switchTab('tab-rounds', this)">
        <span class="nav-icon">üìÖ</span>Rondas
    </div>
    <div class="nav-item" onclick="switchTab('tab-ranking', this)">
        <span class="nav-icon">üèÜ</span>Ranking
    </div>
    <div class="nav-item" onclick="switchTab('tab-export', this)">
        <span class="nav-icon">üìÑ</span>Exportar
    </div>
</div>

<!-- MODAL CONFIRMACI√ìN -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <h3 id="confirmTitle">¬øEst√°s seguro?</h3>
        <p id="confirmMessage">Mensaje de confirmaci√≥n.</p>
        <div class="modal-buttons">
            <button class="secondary" onclick="closeConfirmModal(false)">Cancelar</button>
            <button id="confirmActionBtn" onclick="closeConfirmModal(true)">Confirmar</button>
        </div>
    </div>
</div>

<!-- MODAL CONTRASE√ëA -->
<div id="pwdModal" class="modal">
    <div class="modal-content">
        <h3>Acceso Admin</h3>
        <p>Introduce la contrase√±a:</p>
        <input type="password" id="pwdInput" placeholder="Contrase√±a" onkeydown="if(event.key === 'Enter') checkPassword()">
        <button onclick="checkPassword()">Entrar</button>
        <button class="secondary" onclick="closePasswordModal()" style="margin-top:5px;">Cancelar</button>
    </div>
</div>

<!-- TOAST -->
<div id="toast">Notificaci√≥n</div>

<!-- AUDIO -->
<audio id="tapSound" src="https://github.com/ManuelVS8/Efectos_audio/raw/37b3eb2da9c15c04dfb71dfe1be60f088ea3cdfc/Tap.mp3" preload="auto"></audio>

<script>
    // --- CONFIGURACI√ìN DEFINITIVA ---
    const ADMIN_PASS = "ajedrez2026";
    // URL GOLDILOCKS FINAL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxjeWw4PBusWTnT6ekqNgUNyAc8zEY1UjGnnFS-6j-3BRs5BtbdBIIVs8J0Lgl5SACk/exec";

    let isAdmin = false;
    let appData = { teams: [], matches: [], started: false };
    let currentRound = 1;
    let pendingAction = null;
    let rankingViewMode = 'teams';

    // --- PWA ---
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW registrado', reg))
                .catch(err => console.log('SW fall√≥', err));
        });
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', () => {
        fetchFromGoogle();
    });

    // --- GOOGLE SHEETS INTEGRATION ---

    // FUNCI√ìN FETCHFROMGOOGLE CORREGIDA (Sin saveLocal, mensaje amigable)
    async function fetchFromGoogle() {
        const msg = (appData.teams.length === 0) ? "Iniciando sistema..." : "Sincronizando datos...";
        showLoading(msg);

        try {
            const response = await fetch(`${SCRIPT_URL}?action=read&t=${new Date().getTime()}`);
            if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);

            const text = await response.text();
            const data = JSON.parse(text);
            
            if (data && data.db) {
                appData = data.db;
                renderUI();
            } else {
                if(appData.teams.length === 0) appData = { teams: [], matches: [], started: false };
                renderUI();
            }
            updateAdminMode();
        } catch (error) {
            console.error("Error cargando datos:", error);
            showToast("Error de conexi√≥n. Usando modo local.");
            updateAdminMode();
        } finally {
            hideLoading();
        }
    }

    async function syncToGoogle() {
        if (!isAdmin) {
            showToast("Modo Solo Lectura");
            return;
        }
        
        showLoading("Guardando resultados en la nube...");
        playTap();

        const payload = {
            action: 'sync',
            db: appData 
        };
        
        for (let i = 0; i < 2; i++) {
            try {
                const res = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify(payload),
                    headers: { 'Content-Type': 'application/json' }
                });
                
                showToast(`‚úÖ Datos guardados y sincronizados.`);
                
                // Espera 4 segundos antes de refrescar para evitar leer datos antiguos
                setTimeout(fetchFromGoogle, 4000);
                return; 
            } catch (e) {
                console.warn(`Reintento (${i+1})...`, e);
                if (i === 1) {
                    showToast("‚ùå Error de red al guardar.");
                    hideLoading();
                }
            }
        }
    }

    // FUNCI√ìN SENDGOOGLEACTION (MEJORADA SEG√öN GEMINI)
    async function sendGoogleAction(action, extraData = {}) {
        showLoading("Procesando...");
        try {
            let payload = { action: action, db: appData, ...extraData };
            
            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            return true;
        } catch (error) {
            console.error("Error en acci√≥n Google:", error);
            showToast("Error: " + error.message);
            return false;
        } finally {
            hideLoading();
        }
    }

    // FUNCI√ìN SHOWLOADING CORREGIDA (Con fallback de undefined)
    function showLoading(msg) {
        const loader = document.getElementById('loadingOverlay');
        const text = document.getElementById('loadingText');
        // Usamos el ID camelCase correcto y el fallback para evitar el 'undefined'
        if (text) text.textContent = msg || "Cargando...";
        if (loader) loader.style.display = 'flex';
    }

    function hideLoading() {
        document.getElementById('loadingOverlay').style.display = "none";
    }

    function playTap() {
        const audio = document.getElementById('tapSound');
        if(audio) {
            audio.currentTime = 0;
            audio.play().catch(e => console.log("Audio play blocked"));
        }
    }

    // --- SECURITY / ADMIN ---
    function openPasswordModal() {
        playTap();
        if (isAdmin) {
            isAdmin = false;
            updateAdminMode();
            showToast("Modo Admin desactivado");
        } else {
            const modal = document.getElementById('pwdModal');
            modal.style.display = "flex";
            setTimeout(() => document.getElementById('pwdInput').focus(), 100);
        }
    }

    function closePasswordModal() {
        playTap();
        document.getElementById('pwdModal').style.display = "none";
    }

    function checkPassword() {
        const input = document.getElementById('pwdInput').value;
        if (input === ADMIN_PASS) {
            playTap();
            isAdmin = true;
            closePasswordModal();
            updateAdminMode();
            showToast("Modo Editor activado");
        } else {
            showToast("Contrase√±a incorrecta");
            document.getElementById('pwdInput').value = "";
        }
    }

    function updateAdminMode() {
        const btn = document.getElementById('adminBtn');
        if (isAdmin) {
            btn.innerHTML = "üîì";
            btn.classList.add('unlocked');
            document.body.classList.remove('is-locked');
        } else {
            btn.innerHTML = "üîí";
            btn.classList.remove('unlocked');
            document.body.classList.add('is-locked');
        }
    }

    // --- MODALS ---
    function openConfirmModal(title, message, actionType) {
        playTap();
        document.getElementById('confirmTitle').innerText = title;
        document.getElementById('confirmMessage').innerText = message;
        const btn = document.getElementById('confirmActionBtn');
        btn.className = ""; 
        if (actionType === 'danger') btn.classList.add('danger');
        else btn.style.backgroundColor = "var(--primary)";
        document.getElementById('confirmModal').style.display = "flex";
        pendingAction = actionType;
    }

    function closeConfirmModal(confirmed) {
        playTap();
        document.getElementById('confirmModal').style.display = "none";
        if (confirmed && pendingAction) {
            if (pendingAction === 'start') startTournamentLogic();
            else if (pendingAction === 'reset') resetTournamentLogic();
        }
        pendingAction = null;
    }

    // --- SETUP LOGIC ---
    function renderTeamsSetup() {
        const container = document.getElementById('teamsSetupContainer');
        container.innerHTML = "";
        appData.teams.forEach((team, index) => {
            const teamCard = document.createElement('div');
            teamCard.className = 'team-setup-card';
            let playersHTML = '';
            team.players.forEach((p, pIndex) => {
                playersHTML += `
                    <div class="player-row">
                        <span class="player-num">${pIndex +1}.</span>
                        <input type="text" class="editable-element" value="${p.name}" placeholder="Nombre Jugador" onchange="updatePlayerName(${index}, ${pIndex}, this.value)">
                        ${isAdmin ? `<button class="danger small" onclick="removePlayer(${index}, ${pIndex})">√ó</button>` : ''}
                    </div>
                `;
            });
            teamCard.innerHTML = `
                <div class="team-header">
                    <input type="text" class="editable-element" value="${team.name}" placeholder="Nombre del Equipo" onchange="updateTeamName(${index}, this.value)">
                    ${isAdmin && appData.teams.length >1 ? `<button class="danger small" onclick="removeTeam(${index})">Eliminar</button>` : ''}
                </div>
                <div class="player-list">${playersHTML}<div style="margin-top: 10px; text-align: center;"><button class="secondary editable-element small" style="width:100%; font-size: 0.8rem;" onclick="addPlayerToTeam(${index})">+ A√±adir Jugador</button></div></div>
            `;
            container.appendChild(teamCard);
        });
    }

    function addNewTeamUI() {
        if(!isAdmin) return;
        const newId = Date.now().toString();
        appData.teams.push({ id: newId, name: `Equipo ${appData.teams.length +1}`, players: [ { id: newId + "_p1", name: "" }, { id: newId + "_p2", name: "" } ] });
        renderTeamsSetup(); playTap();
    }

    function removeTeam(teamIndex) {
        if(!isAdmin) return;
        if (confirm("¬øEliminar este equipo?")) { appData.teams.splice(teamIndex, 1); renderTeamsSetup(); }
    }

    function updateTeamName(index, val) { appData.teams[index].name = val; }
    function addPlayerToTeam(teamIndex) {
        if(!isAdmin) return;
        const teamId = appData.teams[teamIndex].id;
        appData.teams[teamIndex].players.push({ id: teamId + "_p" + (Date.now()), name: "" });
        renderTeamsSetup();
    }
    function removePlayer(teamIndex, playerIndex) {
        if(!isAdmin) return;
        appData.teams[teamIndex].players.splice(playerIndex, 1);
        renderTeamsSetup();
    }
    function updatePlayerName(teamIndex, playerIndex, val) {
        appData.teams[teamIndex].players[playerIndex].name = val;
    }

    // --- TOURNAMENT LOGIC (UNIVERSAL BERGER + SCHEVENINGEN - GEMINI VERSION) ---
    function confirmStartTournament() {
        if (!isAdmin) return showToast("Necesitas ser Admin");
        const validTeams = appData.teams.filter(t => t.players.length > 0);
        if (validTeams.length < 2) return showToast("Se necesitan al menos 2 equipos con jugadores");
        
        let title = "Crear Torneo";
        let msg = "¬øSeguro que quieres crear el torneo con estos equipos?";
        if (appData.started) {
            title = "Actualizar Torneo";
            msg = "ATENCI√ìN: Esto borrar√° los resultados actuales y generar√° nuevos emparejamientos.";
        }
        openConfirmModal(title, msg, 'start');
    }

    // VERSI√ìN MEJORADA DE GEMINI INTEGRADA
    function startTournamentLogic() {
        playTap();
        
        // 1. Sorteo aleatorio (Justicia)
        let shuffledTeams = [...appData.teams].sort(() => Math.random() - 0.5);
        
        // 2. A√±adir BYE si es impar
        if (shuffledTeams.length % 2 !== 0) {
            shuffledTeams.push({ id: "bye", name: "DESCANSA", players: [] });
        }
        
        const n = shuffledTeams.length;
        const totalRounds = n - 1;
        const matches = [];

        // 3. Algoritmo de C√≠rculo (Berger Din√°mico)
        let pivot = shuffledTeams[0];
        let rotating = shuffledTeams.slice(1);

        for (let r = 1; r <= totalRounds; r++) {
            let roundTeams = [pivot, ...rotating];
            for (let i = 0; i < n / 2; i++) {
                let t1 = roundTeams[i];
                let t2 = roundTeams[n - 1 - i];

                if (t1.id !== "bye" && t2.id !== "bye") {
                    // Alternancia de colores por Ronda y Tablero (Scheveningen)
                    // En ronda impar: t1 es local (blancas impares). En par: t2 es local.
                    let isT1Local = (r % 2 !== 0) ? (i % 2 === 0) : (i % 2 !== 0);
                    let local = isT1Local ? t1 : t2;
                    let visit = isT1Local ? t2 : t1;

                    const teamMatchId = `R${r}_M${i}`;
                    // M√°ximo de tableros entre ambos equipos
                    const maxBoards = Math.max(local.players.length, visit.players.length);

                    for (let b =1; b <= maxBoards; b++) {
                        // Scheveningen: Local tiene blancas en impares
                        let localIsWhite = (b % 2 !== 0);

                        matches.push({
                            id: `${teamMatchId}_B${b}`,
                            round: r,
                            teamMatchId: teamMatchId,
                            team1Id: local.id,
                            team2Id: visit.id,
                            player1Id: local.players[b-1] ? local.players[b-1].id : "vacante",
                            player2Id: visit.players[b-1] ? visit.players[b-1].id : "vacante",
                            boardNum: b,
                            localIsWhite: localIsWhite,
                            result: ""
                        });
                    }
                }
            }
            // Rotaci√≥n para siguiente ronda
            rotating.unshift(rotating.pop());
        }

        appData.matches = matches;
        appData.started = true;
        
        showLoading();
        sendGoogleAction('create').then(() => {
            hideLoading();
            renderUI();
            switchTab('tab-rounds', document.querySelectorAll('.nav-item')[1]);
            showToast("Torneo FIDE generado con √©xito");
        });
    }

    function confirmResetTournament() {
        if (!isAdmin) return;
        openConfirmModal("Borrar Todo", "ATENCI√ìN: Se eliminar√° toda la informaci√≥n.", 'reset');
    }

    function resetTournamentLogic() {
        playTap();
        showLoading();
        sendGoogleAction('reset').then(() => {
            appData = { teams: [], matches: [], started: false };
            hideLoading();
            renderUI(); 
            showToast("Torneo borrado");
        });
    }

    function updateMatch(matchId, result) {
        if (!isAdmin) return; 
        playTap();
        const match = appData.matches.find(m => m.id === matchId);
        if (match) match.result = result;
        renderMatches(currentRound); renderRoundSelector();
    }

    // --- RENDERING ---

    // FUNCI√ìN RENDERUI BASE
    function renderUI() {
        if (appData.started) {
            document.getElementById('resetCard').style.display = "block";
            renderRoundSelector();
            renderMatches(currentRound);
            renderRanking();
        } else {
            document.getElementById('resetCard').style.display = "none";
            document.getElementById('roundSelector').innerHTML = "";
            document.getElementById('matchesContainer').innerHTML = "<p style='text-align:center'>No hay torneo activo.</p>";
            document.querySelector('#rankingTable tbody').innerHTML = "";
        }
        renderTeamsSetup();
    }

    function renderRoundSelector() {
        const totalRounds = appData.matches.length > 0 ? Math.max(...appData.matches.map(m => m.round)) : 0;
        const container = document.getElementById('roundSelector');
        container.innerHTML = "";
        for (let i = 1; i <= totalRounds; i++) {
            const chip = document.createElement('div');
            let classes = ["round-chip"];
            const roundMatches = appData.matches.filter(m => m.round === i);
            const hasResults = roundMatches.some(m => m.result !== "");
            if (hasResults) classes.push("has-results");
            if (i === currentRound) classes.push("active");
            chip.className = classes.join(" ");
            chip.innerText = `Ronda ${i}`;
            chip.onclick = () => { playTap(); currentRound = i; renderRoundSelector(); renderMatches(i); };
            container.appendChild(chip);
        }
    }

    // FUNCI√ìN RENDERMATCHES CORREGIDA (Con seguridad undefined)
    function renderMatches(roundNum) {
        const container = document.getElementById('matchesContainer'); // ID CORRECTO (sin s)
        if (!container) return; // Seguridad extra
        container.innerHTML = "";
        const roundMatches = appData.matches.filter(m => m.round === roundNum);

        if (roundMatches.length === 0) {
            container.innerHTML = "<p>No hay partidas para esta ronda.</p>";
            return;
        }

        const teamGroups = {};
        roundMatches.forEach(m => { if (!teamGroups[m.teamMatchId]) teamGroups[m.teamMatchId] = []; teamGroups[m.teamMatchId].push(m); });

        Object.keys(teamGroups).forEach(gId => {
            const groupMatches = teamGroups[gId];
            const t1 = appData.teams.find(t => t.id === groupMatches[0].team1Id);
            const t2 = appData.teams.find(t => t.id === groupMatches[0].team2Id);
            
            // --- SEGURIDAD ANTI-UNDEFINED (Soluci√≥n Gemini + GLM) ---
            if (!t1 || !t2) return; 

            let score1 = 0, score2 = 0;
            groupMatches.forEach(m => {
                if (m.result === '1-0') score1++;
                else if (m.result === '0-1') score2++;
                else if (m.result === '1/2-1/2') { score1 += 0.5; score2 += 0.5; }
            });

            const card = document.createElement('div');
            card.className = 'team-match-card';
            card.innerHTML = `
                <div class="team-match-header">
                    <div style="text-align:center; flex:1;"><div class="team-names">${t1.name}</div><div class="team-subtitle">Local</div></div>
                    <div class="team-score-display" style="color:${score1 > score2 ? 'var(--win-color)' : (score2 > score1 ? 'var(--loss-color)' : 'var(--text)')}">${score1} - ${score2}</div>
                    <div style="text-align:center; flex:1;"><div class="team-names">${t2.name}</div><div class="team-subtitle">Visitante</div></div>
                </div>
            `;

            groupMatches.forEach(m => {
                const p1 = t1.players.find(p => p.id === m.player1Id);
                const p2 = t2.players.find(p => p.id === m.player2Id);
                
                // Si es vacante, no mostramos selector
                if (m.player1Id === "vacante" || m.player2Id === "vacante") {
                    const boardDiv = document.createElement('div');
                    boardDiv.className = 'board-row';
                    boardDiv.innerHTML = `
                         <div class="board-players" style="color:#999; font-style:italic;">
                            Tablero ${m.boardNum}: Mesa vacante (Sin rival)
                        </div>
                    `;
                    card.appendChild(boardDiv);
                    return;
                }

                let p1Class = "board-p1", p2Class = "board-p2";
                
                // Determinamos iconos seg√∫n localIsWhite
                const icon1 = m.localIsWhite ? "‚ôî" : "‚ôö";
                const icon2 = m.localIsWhite ? "‚ôö" : "‚ôî";

                if (m.result === '1-0') { if(m.localIsWhite) { p1Class += " win"; p2Class += " loss"; } else { p2Class += " win"; p1Class += " loss"; } } 
                else if (m.result === '0-1') { if(m.localIsWhite) { p2Class += " win"; p1Class += " loss"; } else { p1Class += " win"; p2Class += " loss"; } } 
                else if (m.result === '1/2-1/2') { p1Class += " draw"; p2Class += " draw"; }

                const boardDiv = document.createElement('div');
                boardDiv.className = 'board-row';
                
                const selectDiv = document.createElement('div');
                selectDiv.style.marginTop = "5px";
                selectDiv.innerHTML = `
                    <div class="board-players">
                        <div class="${p1Class}">${icon1} ${p1 ? p1.name : 'N/A'}</div>
                        <div style="font-size:0.8rem; color:#999; margin:0 5px;">vs</div>
                        <div class="${p2Class}">${p2 ? p2.name : 'N/A'} ${icon2}</div>
                    </div>
                `;
                
                const selectElement = document.createElement('select');
                selectElement.className = 'board-select editable-element';
                
                const opts = [
                    {val: "", txt: "Seleccionar resultado..."},
                    {val: "1-0", txt: "1-0 (Ganan Blancas)"},
                    {val: "0-1", txt: "0-1 (Ganan Negras)"},
                    {val: "1/2-1/2", txt: "¬Ω-¬Ω (Tablas)"}
                ];

                opts.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.val;
                    option.text = opt.txt;
                    if (m.result === opt.val) option.selected = true;
                    selectElement.appendChild(option);
                });

                selectElement.addEventListener('change', (e) => {
                    updateMatch(m.id, e.target.value);
                });

                selectDiv.appendChild(selectElement);
                boardDiv.appendChild(selectDiv);
                card.appendChild(boardDiv);
            });
            container.appendChild(card);
        });
    }

    function toggleRankingView(mode) {
        playTap();
        rankingViewMode = mode;
        document.getElementById('btnRankTeams').className = mode === 'teams' ? 'small secondary toggle-active' : 'small secondary';
        document.getElementById('btnRankPlayers').className = mode === 'players' ? 'small secondary toggle-active' : 'small secondary';
        renderRanking();
    }

    // --- RANKING LOGIC (GEMINI ESTRUCTURA + GLM ESTILO) ---
    function renderRanking() {
        const thead = document.querySelector('#rankingTable thead');
        const tbody = document.querySelector('#rankingTable tbody');
        const infoBox = document.getElementById('tieBreakInfo');
        
        tbody.innerHTML = "";
        thead.innerHTML = "";
        
        const headerRow = document.createElement('tr');
        
        if (rankingViewMode === 'teams') {
            infoBox.innerHTML = `<strong>Sistema de Desempate (Equipos FIDE):</strong>
            1. Match Points (2-1-0) &gt; 2. Game Points &gt; 3. Sonneborn-Berger`;
            
            headerRow.innerHTML = `
                <th class="rank-col">#</th>
                <th>Equipo</th>
                <th class="points-col">MP</th>
                <th class="points-col" style="font-size:0.9rem; color:#777;">GP</th>
                <th class="sb-col">SB</th>
            `;
            thead.appendChild(headerRow);
            
            const stats = calculateRanking(); // Funci√≥n de Gemini
            stats.forEach((t, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="rank-col">${index + 1}</td>
                    <td>${t.name}</td>
                    <td class="points-col">${t.mp}</td>
                    <td class="points-col" style="font-size:0.9rem; color:#777;">${t.gp}</td>
                    <td class="sb-col">${t.sb ? t.sb.toFixed(1) : "-"}</td>
                `;
                tbody.appendChild(tr);
            });

        } else {
            // Ranking Individual (Mantenemos la l√≥gica robusta anterior)
            infoBox.innerHTML = `<strong>Sistema de Desempate (Jugadores):</strong>
            1. Puntos Totales &gt; 2. Sonneborn-Berger &gt; 3. Encuentro Directo &gt; 4. Victorias &gt; 5. Negras`;
            
            headerRow.innerHTML = `
                <th class="rank-col">#</th>
                <th>Jugador (Equipo)</th>
                <th class="points-col">Pts</th>
                <th class="sb-col">SB</th>
            `;
            thead.appendChild(headerRow);

            let playersList = [];
            appData.teams.forEach(t => {
                t.players.forEach(p => {
                    playersList.push({
                        id: p.id,
                        name: p.name,
                        teamName: t.name,
                        points: 0,
                        wins: 0,
                        blackGames: 0,
                        opponents: []
                    });
                });
            });

            appData.matches.forEach(m => {
                let p1 = playersList.find(x => x.id === m.player1Id);
                let p2 = playersList.find(x => x.id === m.player2Id);
                if (p1 && p2) {
                    const isP1Black = !m.localIsWhite; // Usamos la nueva propiedad
                    if (isP1Black) p1.blackGames++;
                    else p2.blackGames++;

                    p1.opponents.push(p2.id);
                    p2.opponents.push(p1.id);

                    if (m.result === '1-0') { p1.points++; p1.wins++; }
                    else if (m.result === '0-1') { p2.points++; p2.wins++; }
                    else if (m.result === '1/2-1/2') { p1.points += 0.5; p2.points += 0.5; }
                }
            });

            playersList.forEach(p => {
                let sb = 0;
                p.opponents.forEach(oppId => {
                    let opp = playersList.find(x => x.id === oppId);
                    if (opp) {
                        const match = appData.matches.find(m => 
                            (m.player1Id === p.id && m.player2Id === oppId) || 
                            (m.player1Id === oppId && m.player2Id === p.id)
                        );
                        if (match && match.result) {
                            let myScore = 0;
                            if (match.player1Id === p.id) {
                                if (match.result === '1-0') myScore = 1;
                                else if (match.result === '0-1') myScore = 0;
                                else myScore = 0.5;
                            } else {
                                if (match.result === '1-0') myScore = 0;
                                else if (match.result === '0-1') myScore = 1;
                                else myScore = 0.5;
                            }
                            if (myScore === 1) sb += opp.points;
                            else if (myScore === 0.5) sb += (opp.points * 0.5);
                        }
                    }
                });
                p.sb = sb;
            });

            playersList.sort((a, b) => compareIndividuals(a, b, playersList));

            playersList.forEach((p, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="rank-col">${index + 1}</td>
                    <td>
                        <div style="font-weight:bold;">${p.name}</div>
                        <div style="font-size:0.8rem; color:#777;">${p.teamName}</div>
                    </td>
                    <td class="points-col">${p.points}</td>
                    <td class="sb-col">${p.sb.toFixed(1)}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    }

    // FUNCI√ìN DE GEMINI (Optimizada)
    function calculateRanking() {
        let stats = appData.teams.map(t => ({
            ...t,
            mp: 0, // Match Points
            gp: 0, // Game Points
            played: 0
        }));

        const matchGroups = {};

        appData.matches.forEach(m => {
            if (!m.result || m.player1Id === "vacante" || m.player2Id === "vacante") return;
            
            let t1 = stats.find(s => s.id === m.team1Id);
            let t2 = stats.find(s => s.id === m.team2Id);
            if (!t1 || !t2) return;

            // Sumar Game Points
            if (m.result === '1-0') t1.gp += 1;
            else if (m.result === '0-1') t2.gp += 1;
            else if (m.result === '1/2-1/2') { t1.gp += 0.5; t2.gp += 0.5; }

            // Agrupar para Match Points
            if (!matchGroups[m.teamMatchId]) matchGroups[m.teamMatchId] = { t1gp: 0, t2gp: 0, t1Id: m.team1Id, t2Id: m.team2Id };
            if (m.result === '1-0') matchGroups[m.teamMatchId].t1gp += 1;
            else if (m.result === '0-1') matchGroups[m.teamMatchId].t2gp += 1;
            else if (m.result === '1/2-1/2') { matchGroups[m.teamMatchId].t1gp += 0.5; matchGroups[m.teamMatchId].t2gp += 0.5; }
        });

        // Calcular Match Points (2 por ganar el encuentro, 1 por empatar)
        Object.values(matchGroups).forEach(group => {
            let t1 = stats.find(s => s.id === group.t1Id);
            let t2 = stats.find(s => s.id === group.t2Id);
            if (t1 && t2) {
                if (group.t1gp > group.t2gp) t1.mp += 2;
                else if (group.t2gp > group.t1gp) t2.mp += 2;
                else if (group.t1gp === group.t2gp && group.t1gp > 0) { t1.mp += 1; t2.mp += 1; }
            }
        });

        // Sonnenborn-Berger de Equipo
        stats.forEach(t => {
            t.sb = 0;
            t.opponents.forEach(oppId => {
                const opp = stats.find(s => s.id === oppId);
                if(opp) {
                    const res = Object.values(matchGroups).find(r => (r.t1Id === t.id && r.t2Id === oppId) || (r.t1Id === oppId && r.t2Id === t.id));
                    if (res) {
                        let myScore = 0;
                        if (res.t1Id === t.id) {
                            if (res.t1gp > res.t2gp) myScore = 1;
                            else if (res.t1gp < res.t2gp) myScore = 0;
                            else myScore = 0.5;
                        } else {
                            if (res.t2gp > res.t1gp) myScore = 1;
                            else if (res.t2gp < res.t1gp) myScore = 0;
                            else myScore = 0.5;
                        }
                        t.sb += (opp.mp * myScore);
                    }
                }
            });
        });

        return stats.sort((a, b) => b.mp - a.mp || b.gp - a.gp || b.sb - a.sb || a.name.localeCompare(b.name));
    }

    function compareIndividuals(a, b, allPlayers) {
        if (Math.abs(b.points - a.points) > 0.001) return b.points - a.points;
        if (Math.abs(b.sb - a.sb) > 0.001) return b.sb - a.sb;
        
        const tiedGroup = allPlayers.filter(p => Math.abs(p.points - a.points) < 0.001 && Math.abs(p.sb - a.sb) < 0.001);
        if (tiedGroup.length === 2) {
            const opp = tiedGroup.find(t => t.id !== a.id);
            const match = appData.matches.find(m => 
                (m.player1Id === a.id && m.player2Id === opp.id) || 
                (m.player1Id === opp.id && m.player2Id === a.id)
            );
            if (match && match.result) {
                let scoreA = 0, scoreB = 0;
                if (match.player1Id === a.id) {
                    if (match.result === '1-0') scoreA = 1;
                    else if (match.result === '0-1') scoreB = 1;
                    else { scoreA = 0.5; scoreB = 0.5; }
                } else {
                    if (match.result === '1-0') scoreB = 1;
                    else if (match.result === '0-1') scoreA = 1;
                    else { scoreA = 0.5; scoreB = 0.5; }
                }
                if (scoreA !== scoreB) return scoreB - scoreA;
            }
        }
        if (b.wins !== a.wins) return b.wins - a.wins;
        if (b.blackGames !== a.blackGames) return b.blackGames - a.blackGames;
        return a.name.localeCompare(b.name);
    }

    function switchTab(tabId, navItem) {
        playTap();
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        navItem.classList.add('active');
        if (tabId === 'tab-ranking') renderRanking();
    }

    function showToast(message) {
        const x = document.getElementById("toast");
        x.innerText = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- PDF LOGIC ---
    function downloadPDF() {
        playTap();
        if (!appData.started) return showToast("No hay datos para exportar");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const pageWidth = doc.internal.pageSize.getWidth();
        const margin = 15;
        let y = 20;

        doc.setFontSize(18);
        doc.setTextColor(44, 62, 80);
        doc.text("Torneo de Ajedrez por Equipos", margin, y);
        y += 10;
        doc.setFontSize(12);
        doc.setTextColor(100);
        doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, margin, y);
        y += 15;

        doc.setFontSize(14);
        doc.setTextColor(0);
        doc.text("Clasificaci√≥n de Equipos", margin, y);
        y += 10;

        const col1 = margin;
        const col2 = margin + 10;
        const col3 = margin + 60;
        const col4 = pageWidth - margin;

        doc.setFontSize(10);
        doc.setFont("helvetica", "bold");
        doc.text("#", col1, y);
        doc.text("Equipo", col2, y);
        doc.text("MP", col3, y); // Match Points
        doc.text("GP", col4, y, { align: "right" }); // Game Points
        y += 7;

        doc.setFont("helvetica", "normal");
        const stats = calculateRanking();
        stats.forEach((t, i) => {
            if (y > 270) { doc.addPage(); y = 20; }
            doc.text(`${i + 1}`, col1, y);
            doc.text(t.name, col2, y);
            doc.text(`${t.mp}`, col3, y);
            doc.text(`${t.gp}`, col4, y, { align: "right" });
            y += 7;
        });

        doc.addPage(); 
        y = 20;
        doc.setFontSize(16);
        doc.setTextColor(44, 62, 80);
        doc.text("Detalle de Partidas", margin, y);
        y += 15;

        const totalRounds = appData.matches.length > 0 ? Math.max(...appData.matches.map(m => m.round)) : 0;
        
        for (let r = 1; r <= totalRounds; r++) {
            const rMatches = appData.matches.filter(m => m.round === r);
            if (rMatches.length === 0) continue;
            if (y > 230) { doc.addPage(); y = 20; }

            doc.setFontSize(13);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(0);
            doc.text(`Ronda ${r}`, margin, y);
            y += 8;
            
            doc.setDrawColor(200);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 8;

            const groups = {};
            rMatches.forEach(m => { if(!groups[m.teamMatchId]) groups[m.teamMatchId] = []; groups[m.teamMatchId].push(m); });

            Object.values(groups).forEach(g => {
                if (y > 270) { doc.addPage(); y = 20; }
                const t1 = appData.teams.find(t => t.id === g[0].team1Id);
                const t2 = appData.teams.find(t => t.id === g[0].team2Id);

                doc.setFont("helvetica", "bold");
                doc.setFontSize(11);
                doc.setTextColor(44, 62, 80);
                const matchTitle = `${t1.name} vs ${t2.name}`;
                doc.text(matchTitle, margin, y);
                y += 6;
                
                doc.setFontSize(9);
                doc.setFont("helvetica", "normal");
                doc.setTextColor(0);
                
                g.forEach(m => {
                    if (y > 270) { doc.addPage(); y = 20; }
                    const p1 = t1.players.find(p => p.id === m.player1Id);
                    const p2 = t2.players.find(p => p.id === m.player2Id);
                    const res = m.result ? m.result : "Pendiente";
                    const p1Name = (m.player1Id === "vacante") ? "VACANTE" : (p1?p1.name:'?');
                    const p2Name = (m.player2Id === "vacante") ? "VACANTE" : (p2?p2.name:'?');
                    
                    doc.text(`  Tablero ${m.boardNum}: ${p1Name} vs ${p2Name} [${res}]`, margin, y);
                    y += 5;
                });
                y += 4;
            });
            y += 6;
        }

        doc.save("Resultado_Torneo_Equipos.pdf");
        showToast("PDF generado");
    }

    document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") {
            console.log("Aplicaci√≥n visible");
            hideLoading();
            const pwdModal = document.getElementById('pwdModal');
            if (pwdModal && pwdModal.style.display === "flex") {
                setTimeout(() => {
                    const input = document.getElementById('pwdInput');
                    if(input) input.focus();
                }, 300);
            }
        }
    });
</script>

</body>
</html>
